version: '3.8'

services:
  mongodb:
    image: mongo:7
    container_name: aetherius-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aetherius-network

  world-state-service:
    build:
      context: .
      dockerfile: packages/world-state-service/Dockerfile
    container_name: aetherius-world-state
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - MONGO_URI=mongodb://mongodb:27017/aetherius_world_state
      - PORT=3000
      - WS_PORT=3001
    ports:
      - "3000:3000"
      - "3001:3001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - aetherius-network
    volumes:
      - ./logs:/app/logs

  bot-server-manager:
    build:
      context: .
      dockerfile: packages/bot-server-manager/Dockerfile
    container_name: aetherius-bsm
    restart: unless-stopped
    depends_on:
      world-state-service:
        condition: service_healthy
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - BSM_WS_PORT=4000
      - BSM_AGENT_PORT=4001
      - ORCHESTRATOR_ADDRESS=${ORCHESTRATOR_ADDRESS:-ws://orchestrator:5001}
      - WORLD_STATE_API_ADDRESS=http://world-state-service:3000
      - MC_HOST=${MC_HOST}
      - MC_PORT=${MC_PORT:-25565}
      - MC_VERSION=${MC_VERSION:-1.20.1}
    ports:
      - "4000:4000"
      - "4001:4001"
    networks:
      - aetherius-network
    volumes:
      - ./logs:/app/logs

  orchestrator:
    build:
      context: .
      dockerfile: packages/orchestrator-service/Dockerfile
    container_name: aetherius-orchestrator
    restart: unless-stopped
    depends_on:
      world-state-service:
        condition: service_healthy
      bot-server-manager:
        condition: service_started
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ORCHESTRATOR_PORT=5000
      - ORCHESTRATOR_WS_PORT=5001
      - WORLD_STATE_API_ADDRESS=http://world-state-service:3000
    ports:
      - "5000:5000"
      - "5001:5001"
    networks:
      - aetherius-network
    volumes:
      - ./logs:/app/logs

  # Optional: Frontend service
  # frontend:
  #   build:
  #     context: .
  #     dockerfile: packages/frontend/Dockerfile
  #   container_name: aetherius-frontend
  #   restart: unless-stopped
  #   depends_on:
  #     - orchestrator
  #   ports:
  #     - "8080:8080"
  #   networks:
  #     - aetherius-network

networks:
  aetherius-network:
    driver: bridge

volumes:
  mongo-data:
    driver: local
  mongo-config:
    driver: local
